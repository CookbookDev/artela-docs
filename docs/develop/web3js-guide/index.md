# Web3.js Guide

# Web3.js: Empowering Aspect and Smart Contract Development

`@artela/web3` is an extended version of Ethereum’s `web3.js` with Aspect operations supported. This package is fully compatible with the original version with some slight modifications. If your dApp is based on the original `web3.js` , you can simply migrate to Artela by replacing the package and import sentences.

# Installation

Execute the the following command to add the package to your JavaScript / TypeScript project:

```bash
npm install @artela/web3 --save
```

# Deploy Smart Contract

You can deploy your smart contract with `@artela/web3` by the following steps:

1. Load contract byte code and ABI files generated by [ASOLC](https://github.com/artela-network/solidity/releases) (assuming we have a smart contract named `Counter`): 

```jsx
const fs = require('fs')
const bytecode = fs.readFileSync("./test/Counter.bin", "utf-8") // change the bin file it to your own
const abidata = fs.readFileSync("./test/Counter.abi", "utf-8") // change the abi json to your own
var abi = JSON.parse(abidata)
```

2. Connect to Artela test node.

```jsx
const Web3 = require('web3');
const web3 = new Web3('https://artela-devnet-rpc1.artela.network'); // modify it according to your own requirements.
```

3. Retrieve test accounts from our node. 
    
> 💡 You can also use your local account at your preference.
> 

```jsx
// retrieve accounts
let accounts = await web3.atl.getAccounts();

// retrieve current nonce
let nonceVal = await web3.atl.getTransactionCount(accounts[0]);
```

4. Initialize the contract instance and make the deployment.

```jsx
let deployOptions =  {
		gasPrice: '1000000000', // <-- adjust accrodingly
		gas: 4000000            // <-- adjust accrodingly
}
// instantiate an instance of contract
let contract = new web3.atl.Contract(abi);
	// deploy contract
let instance = contract.deploy({data: bytecode}).send({ from: accounts[0], nonce: nonceVal, ...deployOptions});

contract = await instance.on('receipt', function (receipt) {
		console.log("contract address: " + receipt.contractAddress);
}).on('transactionHash', (txHash) => {
		console.log("tx hash: ", txHash);
});
```

> **Note** ⚠️
> 
> 
> Remember to save the `**contract address**`, as it will be used when binding the contract with the Aspect.
> 

# Deploy Aspect

During the deployment of an Aspect, the Aspect binary is stored in the system contract, along with additional details such as the version, properties, and other relevant information.

1. Perform the same steps as in deploying the smart contract: connect to the network, retrieve the account, and obtain the nonce.

```jsx
const Web3 = require('web3');
const web3 = new Web3('https://artela-devnet-rpc1.artela.network'); // modify it according to your own requirements.

// retrieve accounts
let accounts = await web3.atl.getAccounts(); // <-- use your local account

// retrieve current nonce
let nonceVal = await web3.atl.getTransactionCount(accounts[0]);
```

2. Load Aspect binary(assume the binary is in `./build/release.wasm*)`.

```jsx
const fs = require('fs')
let aspectCode = fs.readFileSync('./build/release.wasm', {
		encoding: "hex"
});
```

3. Instantiate the Aspect instance and make the deployment.

```jsx
let deployOptions =  {
		gasPrice: '1000000000', // <-- adjust accrodingly
		gas: 4000000            // <-- adjust accrodingly
}

let aspect = new web3.atl.Aspect(
		web3.utils.aspectCoreAddr, deployOptions);

instance = aspect.deploy({
		data: '0x' + aspectCode,
		properties: [{ 'key': 'owner', 'value': accounts[0] }] // <-- properity of aspect, k-v pairs
}).send({ from: accounts[0], nonce: nonceVal });

aspect = await instance.on('receipt', (receipt) => {
}).on('transactionHash', (txHash) => {
		console.log("deploy aspect tx hash: ", txHash);
});
console.log("aspect address: " + aspect.options.address);
```

> **Note** ⚠️
> 
> 
> Remember to save the `**aspect address**`, as it will be used when binding the contract with the Aspect.
> 

# Binding Aspect To Contract

Aspect binding to a contract is a process that establishes a connection between an Aspect and a smart contract in an Artela network. The connection is built and saved in the system contract.

> **Note**⚠️
> 
> 
> Ensure that both the Aspect and contract deployment have been successfully completed and included in a confirmed block.
> 

1. Perform the same steps as in deploying the smart contract: connect to the network, retrieve the account, and obtain the nonce.

```jsx
const Web3 = require('web3');
const web3 = new Web3('https://artela-devnet-rpc1.artela.network'); // modify it according to your own requirements.

// retrieve accounts
let accounts = await web3.atl.getAccounts(); // <-- use your local account

// retrieve current nonce
let nonceVal = await web3.atl.getTransactionCount(accounts[0]);
```

2. Retrieve contract instance and Aspect address.

> The **`contractAddress`** comes from the saved value generated [here](https://docs.artela.network/develop/web3js-guide)
> 
> 
> The **`aspectAddress`** comes from the saved value generated [here](https://docs.artela.network/develop/web3js-guide) 
> 

```jsx
let contractAddress = '0x...' // <-- contract address, saved in Deploying Contract
let aspectAddress = '0x...' // <-- aspect address, saved in Deploying Aspect
const fs = require('fs')
const abidata = fs.readFileSync("./test/Counter.abi", "utf-8") // change the abi json to your own
var abi = JSON.parse(abidata)
let contract = new web3.atl.Contract(abi, contractAddress)
```

3. Binding Aspect to contract.

```jsx
await contract.bind({
        priority: 1,
        aspectId: aspectAddress,
        aspectVersion: 1,
    }).send({ from: accounts[0], nonce: nonceVal })
        .on('receipt', function (receipt) {
            console.log(receipt)
        })
        .on('transactionHash', (txHash) => {
            console.log("contract binding tx hash: ", txHash);
        });
```

# Invoke The Contract With the Associated Aspect
Binding is the process of linking an aspect to a specific smart contract. When a smart contract binds with an aspect, it means that the execution of the smart contract will trigger the execution of the aspect as well.

1. Perform the same steps as in deploying the smart contract: connect to the network, retrieve the account, and obtain the nonce.

```jsx
const Web3 = require('web3');
const web3 = new Web3('https://artela-devnet-rpc1.artela.network'); // modify it according to your own requirements.

// retrieve accounts
let accounts = await web3.atl.getAccounts(); // <-- use your local account

// retrieve current nonce
let nonceVal = await web3.atl.getTransactionCount(accounts[0]);
```

2. Retrieve contract instance.

> The **`contractAddress`** comes from the saved value generated [here](https://docs.artela.network/develop/web3js-guide)
> 

```jsx
let contractAddress = '0x...' // <-- contract address, saved in Deploying Contract
const fs = require('fs')
const abidata = fs.readFileSync("./test/Counter.abi", "utf-8") // change the abi json to your own
var abi = JSON.parse(abidata)
let contract = new web3.atl.Contract(abi, contractAddress)
```

1. Invoke contract method.

e.g. Counter.sol with a method defined in `function count(uint256 number) public`

```jsx
await contract.methods.count(1)
        .send({ from: accounts[0], nonce: nonceVal, gas: 4000000, gasPrice: '1000000000' })
        .on('receipt', (receipt) => {
            console.log(receipt);
        })
        .on('transactionHash', (txHash) => {
            console.log("call contract tx hash: ", txHash);
        });
```

# Upgrade Aspect

You can update an existing Aspect's code and properties using aspectId by following steps:

1. Perform the same steps as in deploying the smart contract: connect to the network, retrieve the account, and obtain the nonce.

```tsx
const Web3 = require('web3');
const web3 = new Web3('https://artela-devnet-rpc1.artela.network'); // modify it according to your own requirements.

// retrieve accounts
let accounts = await web3.atl.getAccounts(); // <-- use your local account

// retrieve current nonce
let nonceVal = await web3.atl.getTransactionCount(accounts[0]);
```

2. Indicate the aspectId (address) that requires an upgrade, and provide the new byte code and property assignment.

```tsx
const fs = require('fs')
let aspectCode = fs.readFileSync('/Users/likun/go/src/github.com/artela-network/aspect-example/reentrance/build/release.wasm', {
		encoding: "hex"
});
let aspect = new web3.atl.Aspect(
		web3.utils.aspectCoreAddr, deployOptions);

let aspectAddress = '0x7794989a5B0507200E3350eE0Ed96E897fEe5160' // <-- aspect address, saved in Deploying Aspect
```

3. Execute the upgrade with gas options.