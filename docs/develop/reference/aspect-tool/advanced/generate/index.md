# Aspect Generate

Artela EVM introduces additional opcodes, enabling the connection of hashed information to human-readable source code.
But a smart contract contains multiple accounts and variables, and the state changes generated by their contract calls
are a particularly complex data structure. We provide a trace state wrapper class that simplifies access to it.

This guide instructs users on generating a wrapper class using `aspect-tool generate` and provides guidance on its utilization.

## Command

```shell
USAGE
  $ aspect-tool generate [-i <value>] [-o <value>]
FLAGS
  -i, --in=<value>
  -o, --out=<value>
```

## Cases

### 1. create a smart contract

Add a smart contract to the 'contract' directory in the my-first-aspect project (
see [Init Project](/develop/reference/aspect-tool/guide/init)), such as
`HoneyPot.sol`：

```solidity
// SPDX-License-Identifier: GPL-3.0
pragma solidity >=0.8.2 <0.9.0;

contract HoneyPot {
    mapping(address => uint256) public balances;
    address private deployer;
    constructor() {
        deployer = msg.sender;
    }
    function isOwner(address user) external view returns (bool result) {
        if (user == deployer) {
            return true;
        } else {
            return false;
        }
    }

    function deposit() public payable {
        balances[msg.sender] += msg.value;
    }

    function withdraw() public {
        uint bal = balances[msg.sender];
        require(bal > 0);

        (bool sent,) = msg.sender.call{value: bal}("");
        require(sent, "Failed to send Ether");
        address sender = msg.sender;
        balances[sender] = 0;
    }
}
```

### 2. compile contract

Execute the contract compilation command

```shell
npm run contract:build
```

If the command is executed successfully, the following file will be generated in the './build/contract' directory.

```shell
.
├── build
│   ├── contract
│   │   ├── HoneyPot.abi
│   │   ├── HoneyPot.bin
│   │   └── HoneyPot_storage.json

```

### 3. generate trace state wrapper class

```shell
npm run aspect:gen
```

Specifically, the command will be executed, and to generates `./assembly/aspect/honeypot_storage.ts` class.

```shell
aspect-tool generate -i ./build/contract -o ./assembly/aspect
```

### 4. how to work

> The following code shows how to judge the balance change of the current contract and compare the state change of
> balances map that `key==currentCall.from` in the contract, if it is not the same, revert transaction

```typescript
//import 
import {HoneyPotState} from "./honeypot_storage";

class GuardByCountAspect implements IAspectTransaction {
...

    postContractCall(ctx: PostContractCallCtx): void {
        // 1.Calculate the eth balance change of DeFi SmartContract(HoneyPot) before and after tx.
        let sysBalance = new HoneyPotState._balance_(ctx.trace, ctx.currentCall.to);
        let deltaSys = sysBalance.current()!.sub(sysBalance.original());


        // 2.Calculate the financial change of withdrawer in DeFi SmartContract(HoneyPot) before and after tx.
        let contractState = new HoneyPotState.balances(ctx.trace, ctx.currentCall.to);

        let deltaUser = BigInt.ZERO;
        let fromState = contractState.get(ctx.currentCall.from)
        let current = fromState.current()
        let original = fromState.original();
        if (current && original) {
            deltaUser = current.sub(original)
        }
        // 3.Verify if the above two values are equal.
        if (deltaSys.compareTo(deltaUser) != 0) {
            sys.revert("risky transaction")
        }
    }

...
}
```

### 5. compile Aspect

Execute the Aspect compilation command

```shell
npm run aspect:build
```

If the command is executed successfully, WebAssembly is generated in the `build` directory